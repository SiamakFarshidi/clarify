{"name": "4 th place solution inference and training tips ", "full_name": " h1 Import additional packages h1 Import packages h1 Main Config Variables h1 Audio Preprocessing h2 Utils h2 Main Pipeline h2 Torch Dataset h1 Load Dataframe h1 Initialize Dataset h1 torchaudio utils h1 Resnext initialize functions h1 BIG BIG Model class h2 Model utils h1 ALL My Models h1 Predict Loop h1 Create final submission DF h1 Train Tips h2 Augmentations h3 Gain h3 Background Noise h3 LowFrequency CutOff h3 All Pipeline h2 Mixup h2 Multi Sample Dropout h2 Energy trimming ", "stargazers_count": 0, "forks_count": 0, "description": " Import additional packages Import packages Main Config Variables Audio Preprocessing Utils Main Pipeline Torch Dataset Load Dataframe Initialize Dataset torchaudio utils Resnext initialize functions BIG BIG Model class Model utils ALL My Models All models are taken from 5 folds so each experiment contains bunch of 5 models Each model is created by SWA simple averaging of weight matrices from 3 best chekpoints taken for f1 test median Predict Loop Create final submission DF Train Tips Augmentations Great thanks for audiomentations package https github com iver56 audiomentations Gain Taken from https github com iver56 audiomentations python class Gain audiomentations BasicTransform Multiply the audio by a random amplitude factor to reduce or increase the volume This technique can help a model become somewhat invariant to the overall gain of the input audio Warning This transform can return samples outside the 1 1 range which may lead to clipping or wrap distortion depending on what you do with the audio in a later stage See also https en wikipedia org wiki Clipping audio Digital clipping def init self min gain in db 12 max gain in db 12 p 0 5 param p super init p assert min gain in db max gain in db self min gain in db min gain in db self max gain in db max gain in db def randomize parameters self samples sample rate super randomize parameters samples sample rate if self parameters should apply self parameters amplitude ratio convert decibels to amplitude ratio random uniform self min gain in db self max gain in db def apply self samples sample rate return samples self parameters amplitude ratio Background Noise python class SpecifiedNoise audiomentations BasicTransform def init self noise folder path str p int 0 5 allways apply bool False low alpha float 0 0 high alpha float 1 0 super init p filenames glob pjoin noise folder path wav self noises librosa load noise path sr None 0 for noise path in filenames self noises librosa util normalize noise for noise in self noises self p p self allways apply allways apply self low alpha low alpha self high alpha high alpha def apply self au sr if np random binomial n 1 p self p or self allways apply alpha np random uniform low self low alpha high self high alpha noise self noises np random randint low 0 high len self noises au au 1 alpha noise alpha return au LowFrequency CutOff python class LowFrequencyMask audiomentations BasicTransform def init self p int 0 5 allways apply bool False max cutoff float 5 min cutoff float 4 super init p self p p self allways apply allways apply self max cutoff max cutoff self min cutoff min cutoff def apply self au sr if np random binomial n 1 p self p or self allways apply cutoff value np random uniform low self min cutoff high self max cutoff au butter lowpass filter au cutoff cutoff value fs sr 1000 return au All Pipeline noisy samples you can find in this dataset https www kaggle com vladimirsydor cornelli background noises python audiomentations Compose Gain p 0 5 SpecifiedNoise ssd data birdsong recognition noisy samples low alpha 0 5 high alpha 0 8 p 0 1 audiomentations AddBackgroundNoise ssd data birdsong recognition noisy samples min snr in db 0 001 max snr in db 2 p 0 75 LowFrequencyMask min cutoff 5 max cutoff 7 p 0 75 Mixup I have used OR Mixup that was proposed by Dmytro Danevskyi https www kaggle com ddanevskyi here https www kaggle com c freesound audio tagging 2019 discussion 97926 I have used high mixup probability 75 Here is full loss function which includes Mixup and Label Smoothing But Label Smoothing did not work for me in all cases Multi Sample Dropout Originally proposed in this paper https arxiv org pdf 1905 09788 pdf and used by winners of QA competition https www kaggle com c google quest challenge overview python self big dropout nn Dropout p 0 5 self classifier nn Sequential nn Linear nn embed size hidden dims nn ReLU nn Dropout p first dropout rate nn Linear hidden dims hidden dims nn ReLU nn Dropout p second dropout rate nn Linear hidden dims classes num logits torch mean torch stack self classifier self big dropout x for in range 5 dim 0 dim 0 Energy trimming I have created RMS feature with window size of 5 seconds and step size of 1 second Then normalized it in order to use as probability distribution for sampling start second of the audio python def compute normalized energy wave np array wave wave np abs wave max return np power wave 2 def compute sampling distribution feature np ndarray hop size int window size int probs comp str softmax n steps max math ceil len feature window size hop size 1 if probs comp softmax areas feature hop size i window size hop size i sum for i in range n steps probs softmax areas elif probs comp uniform areas feature hop size i window size hop size i sum for i in range n steps probs np array areas sum areas elif probs comp rm softmax areas feature hop size i window size hop size i mean for i in range n steps probs softmax np power np array areas 0 5 else raise ValueError Invalid probs comp return probs h s sr 1 w s sr 5 t pobs compute sampling distribution feature compute normalized energy au hop size h s window size w s probs comp uniform start np random choice len t pobs size 1 p t pobs 0 segment au start h s start h s w s  https github com rwightman gen efficientnet pytorch https github com zhanghang1989 ResNeSt Sample rate of audio Whether to normalize audio by max np abs Minimum length of audio to predict Computational device Inference batch size Thresholding value Maximum amount of birds in raw If None no limit Bird code dict Extract data from dataframe We have to load new audio if only 1 We get new filename 2 We just started and we do not have loaded audio Get duration num of seconds Do not process audio less then one sec Padd if we do not have 5 secs in segment dataset created by shonenkov thanks pack batch twice sum of integer squared unpack batch By default use the entire frame Set the default hop if it s not already specified Pad the window out to n fft size DFT IDFT matrix n fft 2 1 1 n fft n fft 2 1 1 n fft batch size channels num data length batch size n fft 2 1 time steps batch size 1 time steps n fft 2 1 batch size n fft 2 1 time steps n fft 2 1 mel bins Mel spectrogram Logmel spectrogram dim 2 time dim 3 frequency Average over frequency bins Spectral Config Start Spectral Config End Model Config Start Model Config End Feature Extraction Config Start Feature Extraction Config End Other Config Start Other Config End Downsampled ratio Spectrogram extractor Logmel feature extractor Spec augmenter inspired by https github com ex4sperans freesound classification Classifier type Augmentations Final activation Additional features Some additional stuff batch size 1 time steps freq bins batch size 1 time steps mel bins Output shape batch size channels time frequency Output shape batch size channels effnet3 multiscalereluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto Public score 0 613 thresh 0 4 and 0 612 thresh 0 5 effnet4 reluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto Public score 0 61 thresh 0 4 0 605 thresh 0 5 effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto Public score 0 608 thresh 0 4 0 607 thresh 0 5 effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 0 Public score 0 601 thresh 0 4 Is not used in best Blend initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 50bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 ls005 Public score 0 599 thresh 0 5 effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 Public score 0 601 thresh 0 5 effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 Public score 0 606 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto nocalldatax10 swa f1 test median fold 4 pt DEVICE effnet5 multiscalereluclas plato deltas 32bs 2acum 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto Public score 0 607 thresh 0 5 effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto Public score 0 595 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 MD TFE input cornell birds models effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 MD TFE input cornell birds models effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 MD TFE input cornell birds models effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 MD TFE input cornell birds models effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 MD TFE input cornell birds models effnet3 multiscalereluclas plato timefreqencode 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 xeno canto swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 Public score 0 589 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave075 ls01 swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 Public score 0 598 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels mixupsumwave05 swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls005 Public score 0 596 thresh 0 5 effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 Public score 0 593 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels ls01 swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels Public score 0 582 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels swa f1 test median fold 4 pt DEVICE effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto Public score 0 601 thresh 0 5 Is not used in best Blend initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto swa f1 test median fold 1 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto swa f1 test median fold 3 pt DEVICE initalize spectral model NEW EFFNET3 input cornell birds models effnet3 reluclas plato deltas 64bs 001lr biggerfft trackmap energytrimming topdb80 firstaugs secondarylabels extxenocanto swa f1 test median fold 4 pt DEVICE effnet4 multiscalereluclas plato deltas 32bs 2acum 001lr biggerfft trackmap energytrimming topdb80 firstaugsless newbacks secondarylabels mixupsumwave05 xeno canto Public score not commited Is not used in best Blend initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 32bs 2acum 001lr biggerfft trackmap energytrimming topdb80 firstaugsless newbacks secondarylabels mixupsumwave05 xeno canto swa f1 test median fold 0 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 32bs 2acum 001lr biggerfft trackmap energytrimming topdb80 firstaugsless newbacks secondarylabels mixupsumwave05 xeno canto swa f1 test median fold 2 pt DEVICE initalize spectral model NEW EFFNET4 MD input cornell birds models effnet4 multiscalereluclas plato deltas 32bs 2acum 001lr biggerfft trackmap energytrimming topdb80 firstaugsless newbacks secondarylabels mixupsumwave05 xeno canto swa f1 test median fold 4 pt DEVICE If we have site3 we get list of samples If we have site1 or site2 only one sample If site3 produced very big batch we decompose it in smaller ones Or models are blend with simple Mean Or models are blend with simple Mean Concatanate batches Create DataFrame Aggregate predictions from site3 by Max Handle output for clipwise framewise model ", "id": "vladimirsydor/4-th-place-solution-inference-and-training-tips", "size": "6603", "language": "python", "html_url": "https://www.kaggle.com/code/vladimirsydor/4-th-place-solution-inference-and-training-tips", "git_url": "https://www.kaggle.com/code/vladimirsydor/4-th-place-solution-inference-and-training-tips"}